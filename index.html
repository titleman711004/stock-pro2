<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Dashboard Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155; 
            --border-color: #334155; --text-main: #ffffff; --text-sub: #94a3b8;
            --chart-border: #0f172a; --input-text: #ffffff; --row-bg: #111827;
            --row-border: #1f2937; --tech-line: #06b6d4; --tech-text-pct: #06b6d4;
            --btn-bg: #1e293b; --btn-text: #94a3b8;
        }
        [data-theme="ocean"] {
            --bg-body: #0a1929; --bg-card: #132f4c; --bg-input: #1e4976;
            --border-color: #2a6496; --text-main: #e2e8f0; --text-sub: #94a3b8;
            --chart-border: #0a1929; --input-text: #ffffff; --row-bg: #0d2137;
            --row-border: #132f4c; --tech-line: #38bdf8; --tech-text-pct: #38bdf8;
            --btn-bg: #132f4c; --btn-text: #94a3b8;
        }
        [data-theme="oled"] {
            --bg-body: #000000; --bg-card: #121212; --bg-input: #262626;
            --border-color: #333333; --text-main: #e5e5e5; --text-sub: #a3a3a3;
            --chart-border: #000000; --input-text: #e5e5e5; --row-bg: #0a0a0a;
            --row-border: #262626; --tech-line: #22d3ee; --tech-text-pct: #22d3ee;
            --btn-bg: #171717; --btn-text: #a3a3a3;
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, sans-serif; transition: all 0.3s; }
        .input-card { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 2px solid var(--border-color); margin-bottom: 20px; transition: all 0.3s; }
        .input-field { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--input-text) !important; font-size: 16px !important; width: 100%; }
        
        .compact-row { background: var(--row-bg); border: 1px solid var(--row-border); margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; padding: 10px 8px; min-height: 64px; }
        .drag-handle { cursor: move; color: #3b82f6; width: 24px; display: none; align-items: center; justify-content: center; font-size: 18px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-right: 4px; flex-shrink: 0; }
        body.is-sorting .drag-handle { display: flex; }
        
        .num-dot { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 10px; font-weight: bold; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        
        .chart-box { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 12px; position: relative; }
        .master-chart-box { border: 2px solid #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); }
        
        .chart-container { min-height: 280px; position: relative; display: flex; justify-content: center; align-items: center; }
        .master-container { padding: 10px; }
        
        .stacked-bar-container { width: 100%; height: 40px; display: flex; border-radius: 10px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); position: relative; }
        .bar-segment { height: 100%; transition: width 0.5s ease; position: relative; }
        .bar-segment:hover { opacity: 0.9; transform: scaleY(1.05); z-index: 10; }
        
        .master-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .legend-item { display: flex; align-items: center; font-size: 12px; color: var(--text-main); background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 6px; width: calc(50% - 5px); box-sizing: border-box; }
        @media(min-width: 768px) { .legend-item { width: auto; } }

        /* å„ªåŒ–ï¼šå¢åŠ  row çš„ paddingï¼Œçµ¦æ–‡å­—æ›´å¤šç©ºé–“ */
        .detail-legend { margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 8px; }
        .detail-row { display: flex; align-items: center; padding: 8px 8px; border-radius: 6px; margin-bottom: 4px; background: rgba(0,0,0,0.2); font-size: 12px; }
        .detail-row:hover { background: rgba(255,255,255,0.05); }
        
        .checkbox-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .checkbox-label { display: flex; align-items: center; font-size: 12px; color: #94a3b8; cursor: pointer; }
        .checkbox-label input { margin-right: 6px; accent-color: #3b82f6; }
        
        .screenshot-hide { opacity: 1; transition: opacity 0.2s; }
        .capturing .screenshot-hide { opacity: 0 !important; visibility: hidden !important; }
        .edit-only { display: none; }
        body.is-editing .edit-only { display: block; }
        body.is-editing .edit-only-flex { display: flex; }
        .edit-only-flex { display: none; }
        .btn-icon { background: var(--btn-bg); color: var(--btn-text); border: 1px solid var(--border-color); }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #screenshotPreview { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        #screenshotImg { max-width: 100%; max-height: 70vh; border-radius: 12px; box-shadow: 0 0 30px rgba(0,0,0,0.5); margin-bottom: 20px; border: 1px solid #334155; }
    </style>
</head>
<body class="p-3">
    <div id="screenshotPreview">
        <img id="screenshotImg" src="" alt="Screenshot">
        <div class="flex gap-4">
            <button onclick="closeScreenshot()" class="px-6 py-2 bg-slate-700 text-white rounded-full font-bold hover:bg-slate-600 transition">âœ• é—œé–‰</button>
            <a id="downloadLink" href="#" download="chart.jpg" class="px-6 py-2 bg-blue-600 text-white rounded-full font-bold hover:bg-blue-500 transition flex items-center gap-2">â¬‡ ä¸‹è¼‰åœ–ç‰‡</a>
        </div>
    </div>

    <div id="loadingOverlay"><div class="spinner"></div><div class="text-blue-400 font-bold tracking-widest">é«˜æ¸…æ¸²æŸ“ä¸­...</div></div>
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row items-center justify-between mb-6 gap-y-4">
            <div class="flex flex-col items-center md:items-start w-full md:w-auto">
                <div class="flex items-center">
                    <h2 class="text-2xl font-black text-blue-500 italic text-center">DASHBOARD <span class="text-xs text-yellow-400 not-italic ml-1" style="text-shadow: 0 0 10px #facc15, 0 0 20px #854d0e;">PRO</span></h2>
                </div>
                <div class="flex items-center gap-3 mt-1">
                    <button onclick="cycleTheme()" class="text-xs px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-slate-300 hover:text-white transition-all">ğŸ¨ <span id="themeName">é è¨­</span></button>
                    <button id="editBtn" onclick="toggleEditMode()" class="text-xs px-2 py-0.5 rounded border border-blue-600 bg-blue-900/30 text-blue-400 font-bold hover:bg-blue-600 hover:text-white transition-all">âœ ç·¨è¼¯æ¨¡å¼ï¼šOFF</button>
                </div>
            </div>
            <div class="flex gap-3 justify-end w-full md:w-auto edit-only-flex">
                <button onclick="addNewChart()" class="bg-blue-600 text-white text-[10px] px-4 py-2 rounded-lg font-bold shadow-lg hover:scale-105 transition">+ åˆ†çµ„</button>
                <button onclick="copyToClipboard()" class="bg-emerald-700 text-white text-[10px] px-4 py-2 rounded-lg font-bold shadow-lg hover:scale-105 transition">å‚™ä»½</button>
                <button onclick="importFromText()" class="bg-slate-700 text-white text-[10px] px-4 py-2 rounded-lg font-bold shadow-lg hover:scale-105 transition">é‚„åŸ</button>
            </div>
        </header>

        <div id="masterChartWrapper" class="mb-8 hidden">
            <div class="chart-box master-chart-box" id="masterChartBox">
                <h3 class="text-center text-blue-400 font-bold text-xl mb-1 tracking-widest">è³‡ç”¢é…ç½®ç¸½è¦½</h3>
                <div class="text-center text-slate-500 text-xs mb-4 font-mono tracking-wider">ç¸½è³‡ç”¢ï¼š<span id="grandTotal" class="text-emerald-400 font-black text-2xl">0</span> è¬</div>
                
                <button id="masterModeBtn" onclick="cycleMasterMode()" class="screenshot-hide absolute top-3 right-12 btn-icon rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm edit-only">ğŸ“Š</button>
                <button onclick="downloadMasterChart()" class="screenshot-hide absolute top-3 right-3 btn-icon rounded-full w-8 h-8 flex items-center justify-center">ğŸ“·</button>
                
                <div class="master-container">
                    <div id="masterBarContainer" class="hidden"><div id="masterBar" class="stacked-bar-container"></div></div>
                    <div id="masterCanvasContainer" class="chart-container"><canvas id="masterCanvas"></canvas></div>
                    <div id="masterLegend" class="master-legend"></div>
                </div>
            </div>
        </div>

        <div class="edit-only mb-4">
            <div class="checkbox-group shadow-lg border border-slate-700">
                <span class="text-xs font-bold text-blue-400 mr-2">åˆ†çµ„åœ–è¡¨é¡¯ç¤ºé …ç›®ï¼š</span>
                <label class="checkbox-label"><input type="checkbox" id="showSym" onchange="updateLabelPrefs()" checked> ä»£è™Ÿ</label>
                <label class="checkbox-label"><input type="checkbox" id="showNote" onchange="updateLabelPrefs()"> å‚™è¨»</label>
                <label class="checkbox-label"><input type="checkbox" id="showShares" onchange="updateLabelPrefs()" checked> å¼µæ•¸</label>
                <label class="checkbox-label"><input type="checkbox" id="showVal" onchange="updateLabelPrefs()"> å¸‚å€¼</label>
                <label class="checkbox-label"><input type="checkbox" id="showPct" onchange="updateLabelPrefs()"> ä½”æ¯”(%)</label>
            </div>
        </div>

        <div id="chartsWrapper" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6"></div>

        <div id="inputArea" class="input-card shadow-2xl edit-only">
            <input type="hidden" id="editId" value="">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block">è‚¡ç¥¨ä»£è™Ÿ</label><input id="symbol" class="input-field" placeholder="ä¾‹: 2330"></div>
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block">å¼µæ•¸</label><input type="number" id="shares" class="input-field" step="0.001" placeholder="0"></div>
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block">å‡åƒ¹</label><input type="number" id="avgPrice" class="input-field" placeholder="0"></div>
                <div class="col-span-1"><label class="text-[10px] text-emerald-400 mb-1 block">é ˜æ¯</label><input type="number" id="divRec" value="0" class="input-field"></div>
                <div class="col-span-1"><label class="text-[10px] text-orange-400 mb-1 block">ç²åˆ©</label><input type="number" id="gainRec" value="0" class="input-field"></div>
                <div class="col-span-2 md:col-span-5"><label class="text-[10px] text-yellow-500 mb-1 block">å‚™è¨» (æœƒé¡¯ç¤ºåœ¨åœ–è¡¨ä¸‹æ–¹)</label><input id="note" class="input-field" placeholder="è‡ªå®šç¾©å‚™è¨»..."></div>
            </div>
            <button onclick="saveStock()" class="w-full bg-blue-600 py-4 rounded-xl font-black text-xl active:scale-95 transition-all">å„²å­˜ä¸¦åˆ·æ–°</button>
        </div>

        <div class="edit-only">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-sm font-bold text-slate-500 uppercase tracking-widest">è³‡ç”¢åˆ—è¡¨è©³æƒ…</span>
                <button id="sortToggle" onclick="toggleSortMode()" class="text-xs bg-slate-800 border border-slate-600 px-5 py-2 rounded-full text-blue-400 font-bold transition-all">â‡… æ’åºæ¨¡å¼</button>
            </div>
            <div id="groupTabs" class="flex gap-2 overflow-x-auto pb-4 no-scrollbar"></div>
            <div id="mainTable" class="space-y-2 pb-24"></div>
        </div>
    </div>
    <footer class="text-center text-slate-600 text-[10px] mt-8 py-6 border-t border-slate-800 tracking-wider">Copyright Â© Titleman</footer>

    <script>
        let isEditing = localStorage.getItem('isEditingMode') === 'true';
        let isSortMode = false;
        let myAssets = JSON.parse(localStorage.getItem('myAssetsV107') || '[]');
        let chartConfigs = JSON.parse(localStorage.getItem('chartConfigsV110') || '[{"id":1,"title":"ä¸»è¦é…ç½®","selectedIds":[],"chartType":"bar"}]');
        let currentTheme = localStorage.getItem('appThemeV1') || 'dark';
        let masterMode = localStorage.getItem('masterModeV3') || 'bar';
        let labelPrefs = JSON.parse(localStorage.getItem('labelPrefsV1') || '{"showSym":true,"showNote":false,"showShares":true,"showVal":false,"showPct":false}');
        let currentFilterGroup = -1;
        let chartInstances = {}, masterChartInstance = null, sortable = null;

        const uniquePalette = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#fbbf24', '#6366f1', '#d946ef', '#2dd4bf', '#f43f5e', '#a855f7', '#34d399', '#fb7185', '#60a5fa', '#fb923c', '#818cf8'];
        const modeIcons = {'bar': 'â–', 'doughnut': 'ğŸ©', 'polarArea': 'â„ï¸'};

        function getItemColor(index) { return uniquePalette[index % uniquePalette.length]; }
        function getThemeColor(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

        function toggleEditMode() { isEditing = !isEditing; if (!isEditing) isSortMode = false; localStorage.setItem('isEditingMode', isEditing); updateEditUI(); render(); }
        function toggleSortMode() { isSortMode = !isSortMode; const btn = document.getElementById('sortToggle'); if (isSortMode) { document.body.classList.add('is-sorting'); btn.innerText = "âœ“ é–å®šé †åº"; btn.classList.add('bg-blue-600', 'text-white'); } else { document.body.classList.remove('is-sorting'); btn.innerText = "â‡… æ’åºæ¨¡å¼"; btn.classList.remove('bg-blue-600', 'text-white'); if (sortable) { sortable.destroy(); sortable = null; } } render(); }
        function updateEditUI() { 
            const btn = document.getElementById('editBtn'); 
            if (isEditing) { document.body.classList.add('is-editing'); btn.innerText = 'âœ ç·¨è¼¯æ¨¡å¼ï¼šON'; btn.classList.add('text-yellow-400'); } 
            else { document.body.classList.remove('is-editing', 'is-sorting'); btn.innerText = 'âœ ç·¨è¼¯æ¨¡å¼ï¼šOFF'; btn.classList.remove('text-yellow-400'); }
            
            document.getElementById('showSym').checked = labelPrefs.showSym;
            document.getElementById('showNote').checked = labelPrefs.showNote;
            document.getElementById('showShares').checked = labelPrefs.showShares;
            document.getElementById('showVal').checked = labelPrefs.showVal;
            document.getElementById('showPct').checked = labelPrefs.showPct;
        }

        function updateLabelPrefs() {
            labelPrefs = {
                showSym: document.getElementById('showSym').checked,
                showNote: document.getElementById('showNote').checked,
                showShares: document.getElementById('showShares').checked,
                showVal: document.getElementById('showVal').checked,
                showPct: document.getElementById('showPct').checked
            };
            localStorage.setItem('labelPrefsV1', JSON.stringify(labelPrefs));
            render();
        }

        function initSortable() {
            const el = document.getElementById('mainTable'); if (!el || !isSortMode) return; if (sortable) sortable.destroy();
            sortable = Sortable.create(el, { handle: '.drag-handle', animation: 200, onEnd: () => { const rows = Array.from(el.querySelectorAll('.compact-row')); const newIds = rows.map(r => parseInt(r.dataset.id)); myAssets = newIds.map(id => myAssets.find(a => a.id === id)); localStorage.setItem('myAssetsV107', JSON.stringify(myAssets)); render(); } });
        }

        function cycleMasterMode() {
            const modes = ['bar', 'doughnut', 'polarArea'];
            let nextIndex = (modes.indexOf(masterMode) + 1) % modes.length;
            masterMode = modes[nextIndex];
            localStorage.setItem('masterModeV3', masterMode);
            render();
        }

        function cycleChartMode(index) {
            const modes = ['bar', 'doughnut', 'polarArea'];
            const current = chartConfigs[index].chartType || 'bar';
            let nextIndex = (modes.indexOf(current) + 1) % modes.length;
            chartConfigs[index].chartType = modes[nextIndex];
            render();
        }

        function render() {
            localStorage.setItem('myAssetsV107', JSON.stringify(myAssets));
            localStorage.setItem('chartConfigsV110', JSON.stringify(chartConfigs));
            const textColor = getThemeColor('--text-main');

            // 1. ç¸½è³‡ç”¢æ¸²æŸ“
            document.getElementById('masterModeBtn').innerText = modeIcons[masterMode];
            let grandTotal = 0; const mLabels = [], mData = [], mColors = [];
            chartConfigs.forEach((conf, i) => {
                let groupTotal = 0;
                conf.selectedIds.forEach(sid => { const s = myAssets.find(a => a.id == sid); if(s) groupTotal += Math.max(0, (s.avgPrice*s.shares*1000)-(s.divRec||0)-(s.gainRec||0)); });
                if(groupTotal > 0) { mLabels.push(conf.title); mData.push(groupTotal); mColors.push(getItemColor(i)); grandTotal += groupTotal; }
            });
            document.getElementById('grandTotal').innerText = (grandTotal / 10000).toFixed(1);
            
            if(grandTotal > 0) {
                document.getElementById('masterChartWrapper').classList.remove('hidden');
                const legendEl = document.getElementById('masterLegend');
                legendEl.innerHTML = '';
                mLabels.forEach((label, i) => {
                    const pct = ((mData[i] / grandTotal) * 100).toFixed(1) + '%';
                    const valWan = (mData[i] / 10000).toFixed(1) + 'è¬';
                    const color = mColors[i];
                    legendEl.innerHTML += `<div class="legend-item"><div class="w-3 h-3 rounded-full mr-2" style="background:${color}"></div><span class="mr-1 text-slate-200">${label}</span><div class="ml-auto flex items-center gap-1"><span class="text-white font-bold">${valWan}</span><span class="text-slate-500 text-[10px]">(${pct})</span></div></div>`;
                });

                const ctxM = document.getElementById('masterCanvas').getContext('2d');
                const barCont = document.getElementById('masterBarContainer');
                const canvasCont = document.getElementById('masterCanvasContainer');
                
                if (masterMode === 'bar') {
                    barCont.classList.remove('hidden');
                    canvasCont.classList.add('hidden');
                    const barEl = document.getElementById('masterBar');
                    barEl.innerHTML = '';
                    mLabels.forEach((label, i) => {
                        const pct = (mData[i] / grandTotal) * 100;
                        const segment = document.createElement('div');
                        segment.className = 'bar-segment';
                        segment.style.width = pct + '%';
                        segment.style.backgroundColor = mColors[i];
                        segment.title = `${label}: ${pct.toFixed(1)}%`;
                        barEl.appendChild(segment);
                    });
                } else {
                    barCont.classList.add('hidden');
                    canvasCont.classList.remove('hidden');
                    if (masterChartInstance) masterChartInstance.destroy();
                    masterChartInstance = new Chart(ctxM, {
                        type: masterMode,
                        data: { labels: mLabels, datasets: [{ data: mData, backgroundColor: mColors, borderWidth: 0 }]},
                        options: { 
                            responsive: true, maintainAspectRatio: false, 
                            cutout: masterMode === 'doughnut' ? '60%' : '0%',
                            scales: masterMode === 'polarArea' ? { r: { ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } } : {},
                            layout: { padding: 30 },
                            plugins: { legend: { display: false }, datalabels: { display: false } }
                        }
                    });
                }
            }

            // 2. åˆ†çµ„åœ–è¡¨æ¸²æŸ“
            const wrapper = document.getElementById('chartsWrapper'); 
            wrapper.innerHTML = ''; 
            
            chartConfigs.forEach((conf, i) => {
                const mode = conf.chartType || 'bar';
                let totalCost = 0; 
                const dItems = [];

                conf.selectedIds.forEach(sid => {
                    const idx = myAssets.findIndex(a => a.id == sid);
                    if(idx!==-1) { 
                        const s = myAssets[idx];
                        const cost = Math.max(1, (s.avgPrice*s.shares*1000)-(s.divRec||0)-(s.gainRec||0));
                        totalCost += cost;
                        dItems.push({ 
                            symbol: s.symbol,
                            note: s.note,
                            shares: s.shares,
                            avgPrice: s.avgPrice,
                            cost: cost,
                            color: getItemColor(idx)
                        });
                    }
                });

                if (mode === 'bar') dItems.sort((a, b) => b.cost - a.cost);
                
                const legendHTML = dItems.map((item) => {
                    // â˜… çµ‚æ¥µä¿®å¾©ï¼šæ‹¿æ‰æ‰€æœ‰ overflow-hiddenï¼Œä½¿ç”¨ padding å’Œ leading-relaxed
                    const noteDisplay = item.note ? `<span class="text-orange-400 font-bold text-xs ml-1 truncate leading-relaxed">(${item.note})</span>` : '';
                    const totalWan = (item.cost / 10000).toFixed(1);
                    return `
                    <div class="detail-row">
                        <div class="flex items-center min-w-0 flex-1 pb-1"> <div class="w-2.5 h-2.5 rounded-full flex-shrink-0 mr-2" style="background:${item.color}"></div>
                            <span class="text-white font-bold mr-1 leading-relaxed">${item.symbol}</span> ${noteDisplay}
                        </div>
                        <div class="flex items-center flex-shrink-0 gap-2 text-right">
                            <span class="text-blue-400 font-mono w-12 text-center">${item.shares}<span class="text-[9px] text-slate-500 ml-0.5">å¼µ</span></span>
                            <span class="text-white font-mono w-12 font-bold text-center">${totalWan}<span class="text-[9px] text-slate-500 ml-0.5">è¬</span></span>
                            <span class="text-emerald-400 font-mono w-12 text-center">${item.avgPrice}</span>
                        </div>
                    </div>`;
                }).join('');

                wrapper.innerHTML += `
                    <div class="chart-box" id="chart-box-${i}">
                        <input type="text" ${isEditing ? '' : 'readonly'} onchange="chartConfigs[${i}].title=this.value;render()" value="${conf.title}" class="bg-transparent border-none font-bold text-blue-400 text-center w-full mb-1 text-lg">
                        <div class="text-center text-slate-500 text-xs mb-2">å¸‚å€¼ï¼š<span class="text-emerald-400 font-black text-base">${(totalCost/10000).toFixed(1)}</span> è¬</div>
                        
                        <button onclick="cycleChartMode(${i})" class="screenshot-hide absolute top-3 right-12 btn-icon rounded-full w-8 h-8 flex items-center justify-center edit-only text-sm">${modeIcons[mode]}</button>
                        <button onclick="downloadChart(${i})" class="screenshot-hide absolute top-3 right-2 btn-icon rounded-full w-8 h-8 flex items-center justify-center">ğŸ“·</button>
                        <button onclick="deleteChart(${i})" class="screenshot-hide absolute top-3 left-3 btn-icon rounded-full w-8 h-8 flex items-center justify-center edit-only">âœ•</button>
                        
                        <div class="chart-container"><canvas id="canvas-${i}"></canvas></div>
                        
                        <div class="detail-legend">
                            <div class="flex justify-between px-2 mb-1 text-[9px] text-slate-500">
                                <span>æ¨™çš„ / å‚™è¨»</span>
                                <span class="pr-2 flex gap-2 justify-end w-40">
                                    <span class="w-12 text-center">å¼µæ•¸</span>
                                    <span class="w-12 text-center">ç¸½é¡</span>
                                    <span class="w-12 text-center">å‡åƒ¹</span>
                                </span>
                            </div>
                            ${legendHTML || '<div class="text-center text-slate-600 text-xs py-2">ç„¡è³‡ç”¢</div>'}
                        </div>
                    </div>`;
            });

            setTimeout(() => {
                chartConfigs.forEach((conf, i) => {
                    const canvas = document.getElementById(`canvas-${i}`);
                    if (!canvas) return;
                    
                    const mode = conf.chartType || 'bar';
                    const ctx = canvas.getContext('2d');
                    
                    const dItems = [];
                    conf.selectedIds.forEach(sid => {
                        const idx = myAssets.findIndex(a => a.id == sid);
                        if(idx!==-1) { 
                            const s = myAssets[idx];
                            const cost = Math.max(1, (s.avgPrice*s.shares*1000)-(s.divRec||0)-(s.gainRec||0));
                            dItems.push({ label: s.symbol, data: cost, shares: s.shares, note: s.note, color: getItemColor(idx) });
                        }
                    });
                    if (mode === 'bar') dItems.sort((a, b) => b.data - a.data);
                    
                    const totalGroupCost = dItems.reduce((acc, curr) => acc + curr.data, 0);

                    if (chartInstances[i]) chartInstances[i].destroy();

                    if (mode === 'bar') {
                        chartInstances[i] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: dItems.map(d=>d.label),
                                datasets: [{
                                    data: dItems.map(d=>d.data),
                                    backgroundColor: dItems.map(d=>d.color),
                                    borderRadius: 4, barPercentage: 0.6
                                }]
                            },
                            options: {
                                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                                layout: { padding: { left:0, right:40, top:10, bottom:10 } },
                                scales: { x: { display:false }, y: { grid:{display:false}, ticks:{color:textColor, font:{weight:'bold', size:13}} } },
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: '#fff', anchor: 'end', align: 'end', offset: 4,
                                        textAlign: 'center',
                                        font: { weight: 'bold', size: 11 },
                                        formatter: (v, c) => {
                                            const item = dItems[c.dataIndex];
                                            let text = [];
                                            if(labelPrefs.showSym) text.push(item.label);
                                            let valText = [];
                                            if(labelPrefs.showShares) valText.push(item.shares + 'å¼µ');
                                            if(labelPrefs.showVal) valText.push((v/10000).toFixed(1) + 'è¬');
                                            if(labelPrefs.showPct) valText.push(((v/totalGroupCost)*100).toFixed(1) + '%');
                                            return valText.join(' ');
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        chartInstances[i] = new Chart(ctx, {
                            type: mode,
                            data: {
                                labels: dItems.map(d=>d.label),
                                datasets: [{
                                    data: dItems.map(d=>d.data),
                                    backgroundColor: dItems.map(d=>d.color),
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                cutout: mode === 'doughnut' ? '60%' : '0%',
                                scales: mode === 'polarArea' ? { r: { ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } } : {},
                                layout: { padding: 30 },
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: (c) => mode === 'doughnut' ? getThemeColor('--text-main') : '#fff',
                                        align: 'end', anchor: 'end', offset: 4,
                                        textAlign: 'center', 
                                        font: { weight: 'bold', size: 11 },
                                        formatter: (v, c) => {
                                            const item = dItems[c.dataIndex];
                                            let lines = [];
                                            if(labelPrefs.showSym) lines.push(item.label);
                                            if(labelPrefs.showNote && item.note) lines.push(item.note);
                                            if(labelPrefs.showShares) lines.push(item.shares + 'å¼µ');
                                            if(labelPrefs.showVal) lines.push((v/10000).toFixed(1) + 'è¬');
                                            if(labelPrefs.showPct) lines.push(((v/totalGroupCost)*100).toFixed(1) + '%');
                                            return lines.join('\n');
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
            }, 0);

            if (isEditing) {
                const tabs = document.getElementById('groupTabs');
                tabs.innerHTML = `<button onclick="filterGroup(-1)" class="px-4 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${currentFilterGroup === -1 ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}">å…¨éƒ¨</button>`;
                chartConfigs.forEach((conf, i) => {
                    const isActive = currentFilterGroup === i;
                    tabs.innerHTML += `<div class="flex items-center gap-1 p-1 rounded-lg ${isActive ? 'bg-blue-900/40 border border-blue-500' : 'bg-slate-800 border border-slate-700'}"><button onclick="filterGroup(${i})" class="px-2 py-0.5 text-xs font-bold whitespace-nowrap ${isActive ? 'text-blue-300' : 'text-slate-400'}">${conf.title}</button><span onclick="editChartTitle(${i})" class="cursor-pointer text-[10px] opacity-40 hover:opacity-100 pr-1">âœ</span></div>`;
                });

                const body = document.getElementById('mainTable'); body.innerHTML = '';
                const filtered = currentFilterGroup === -1 ? myAssets : myAssets.filter(item => chartConfigs[currentFilterGroup].selectedIds.includes(parseInt(item.id)));
                
                filtered.forEach((item) => {
                    const originalIdx = myAssets.findIndex(a => a.id === item.id); const stockColor = getItemColor(originalIdx);
                    let btns = ''; chartConfigs.forEach((c, ci) => { btns += `<div onclick="event.stopPropagation(); toggleToChart(${item.id}, ${ci})" style="${c.selectedIds.includes(parseInt(item.id)) ? `background:${stockColor};color:white;` : `background:var(--row-border);color:var(--text-sub);`}" class="num-dot border border-slate-700 flex-shrink-0">${ci+1}</div>`; });
                    const tCost = (item.avgPrice * item.shares * 1000) - (item.divRec || 0) - (item.gainRec || 0);
                    const perCost = item.shares > 0 ? (tCost / (item.shares * 1000)).toFixed(2) : 0;
                    
                    body.innerHTML += `
                    <div class="compact-row" data-id="${item.id}">
                        <div class="drag-handle">â˜°</div>
                        <div class="w-1.5 h-10 rounded-full flex-shrink-0 mr-3" style="background:${stockColor}"></div>
                        <div class="flex-1 flex flex-col justify-center min-w-0 mr-1 overflow-hidden">
                            <div class="font-bold text-sm text-white truncate mb-0.5">${item.symbol} ${item.note ? `<span class="text-orange-400 font-bold text-xs ml-1">(${item.note})</span>` : ''}</div>
                            <div class="flex items-center text-[11px] leading-none space-x-2">
                                <span class="bg-slate-800 text-slate-300 px-1 py-0.5 rounded border border-slate-700 whitespace-nowrap text-[9px]">${item.shares} å¼µ</span>
                                <span class="text-emerald-400 font-mono text-[11px] whitespace-nowrap">${perCost}</span>
                                <span class="text-slate-500 text-[9px] ml-auto">(${(tCost/10000).toFixed(1)}è¬)</span>
                            </div>
                        </div>
                        <div class="flex gap-[1px] flex-shrink-0 items-center ml-1">${btns}</div>
                        <div class="flex gap-1 flex-shrink-0 ml-1 items-center">
                            <span onclick="editItem(${item.id})" class="text-blue-500 font-bold text-xs cursor-pointer p-1">æ”¹</span>
                            <span onclick="deleteItem(${item.id})" class="text-slate-700 text-xs cursor-pointer p-1">âœ•</span>
                        </div>
                    </div>`;
                });
                if (isSortMode) setTimeout(initSortable, 0);
            }
        }

        function filterGroup(i) { currentFilterGroup=i; render(); }
        function applyTheme(t) { document.documentElement.setAttribute('data-theme', t); currentTheme=t; localStorage.setItem('appThemeV1', t); document.getElementById('themeName').innerText=t==='dark'?'é è¨­':(t==='ocean'?'æµ·æ´‹':'OLED'); render(); }
        function cycleTheme() { const o=['dark','ocean','oled']; applyTheme(o[(o.indexOf(currentTheme)+1)%o.length]); }
        function toggleToChart(sid, ci) { const arr=chartConfigs[ci].selectedIds; const idx=arr.indexOf(parseInt(sid)); if(idx>-1) arr.splice(idx,1); else arr.push(parseInt(sid)); render(); }
        
        function saveStock() {
            const sym = document.getElementById('symbol').value.trim(); if(!sym) return;
            const editId = document.getElementById('editId').value;
            const data = { id: editId?parseInt(editId):Date.now(), symbol: sym.toUpperCase(), fontSize: 12, shares: parseFloat(document.getElementById('shares').value)||0, avgPrice: parseFloat(document.getElementById('avgPrice').value)||0, divRec: parseFloat(document.getElementById('divRec').value)||0, gainRec: parseFloat(document.getElementById('gainRec').value)||0, note: document.getElementById('note').value.trim() };
            if(editId) myAssets[myAssets.findIndex(i=>i.id==editId)] = data;
            else { myAssets.push(data); if(chartConfigs.length>0) chartConfigs[0].selectedIds.push(data.id); }
            ["editId","symbol","shares","avgPrice","divRec","gainRec","note"].forEach(id=>document.getElementById(id).value=(id.includes('Rec')?0:""));
            render();
        }
        function editItem(id) { const item = myAssets.find(i=>i.id==id); ["symbol","shares","avgPrice","divRec","gainRec","note"].forEach(k=>document.getElementById(k).value=item[k]||(k.includes('Rec')?0:"")); document.getElementById('editId').value=item.id; document.getElementById('inputArea').scrollIntoView({behavior:'smooth', block:'center'}); }
        function editChartTitle(i) { const t=prompt("æ–°åç¨±ï¼š", chartConfigs[i].title); if(t){chartConfigs[i].title=t; render();}}
        function addNewChart() { const t=prompt("çµ„åˆ¥åç¨±ï¼š"); if(t){ chartConfigs.push({id:Date.now(), title:t, selectedIds:[], chartType:'bar'}); render(); }}
        function deleteChart(idx) { if(confirm("åˆªé™¤åˆ†çµ„ï¼Ÿ")) { chartConfigs.splice(idx,1); render(); }}
        function deleteItem(id) { if(confirm("åˆªé™¤è³‡ç”¢ï¼Ÿ")) { myAssets=myAssets.filter(i=>i.id!==id); render(); }}
        function downloadMasterChart() { captureAndOpenImage(document.getElementById('masterChartBox'), "è³‡ç”¢ç¸½è¦½"); }
        function downloadChart(i) { captureAndOpenImage(document.getElementById(`chart-box-${i}`), chartConfigs[i].title); }

        function captureAndOpenImage(el, name) {
            const loading = document.getElementById('loadingOverlay'); 
            loading.style.display='flex'; 
            el.classList.add('capturing');
            
            // ä¿æŒåº•éƒ¨ç·©è¡ï¼Œä»¥é˜²è¬ä¸€
            const originalPb = el.style.paddingBottom;
            el.style.paddingBottom = '50px'; 
            
            setTimeout(() => {
                html2canvas(el, { scale:4, backgroundColor:getThemeColor('--bg-card') }).then(canvas => {
                    el.style.paddingBottom = originalPb;
                    loading.style.display='none'; 
                    el.classList.remove('capturing');
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const preview = document.getElementById('screenshotPreview');
                    const img = document.getElementById('screenshotImg');
                    const downloadLink = document.getElementById('downloadLink');
                    
                    img.src = imgData;
                    downloadLink.href = imgData;
                    downloadLink.download = name + '.jpg';
                    
                    preview.style.display = 'flex';
                });
            }, 200);
        }

        function closeScreenshot() {
            document.getElementById('screenshotPreview').style.display = 'none';
        }

        function copyToClipboard() { const d = btoa(encodeURIComponent(JSON.stringify({myAssets, chartConfigs}))); navigator.clipboard.writeText(d).then(()=>alert("å‚™ä»½æˆåŠŸï¼")); }
        function importFromText() { const c = prompt("è¼¸å…¥ä»£ç¢¼ï¼š"); if(c){ try { const d=JSON.parse(decodeURIComponent(atob(c))); myAssets=d.myAssets; chartConfigs=d.chartConfigs; render(); }catch(e){alert("å¤±æ•—");}}}
        window.onload = () => { updateEditUI(); Chart.register(ChartDataLabels); render(); };
    </script>
</body>
</html>

